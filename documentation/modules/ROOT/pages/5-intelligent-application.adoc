= 5. Building and deploying an intelligent application - 10 minutes
:imagesdir: ../assets/images

これからデプロイするアプリケーションは、AI/ML を活用した *インテリジェントな* 機能をアプリケーションに追加する方法の簡単な例です。これは、拡張現実の方法で、店舗で見られるさまざまな商品のクーポンを見つけるために携帯電話で使用できる Web アプリです。

== 5.1. アーキテクチャ

++++
<style>
.mermaid {
  width: 100%;
}
</style>
++++
[mermaid]
....
sequenceDiagram
autonumber

participant f as Frontend
participant b as Backend
participant p as Pre-Post Processing Service
participant m as Model Server

f ->> b : Send the image<br/>to analyze
b ->> p : Pass the image to<br/>the pre-post processing service
p ->> m : Pre-process the image<br/>and call the model server
m ->> p : Send back the inference result
p ->> b : Post-process the inference<br/>and send back the result
b ->> f : Pass the result to<br/>the frontend for display
....

コンポーネントは次のとおりです。

* The Frontend: https://react.dev/[React^] アプリケーション。通常は携帯電話のブラウザ上で実行されます。
* The Backend: NodeJS サーバー。アプリケーションを提供し、API 呼び出しを中継します。
* The Pre-Post Processing Service: Python https://fastapi.tiangolo.com/[FastAPI^] サービス。画像の前処理を実行し、モデル サーバー API を呼び出し、結果を送り返す前に後処理を実行します。
* The Model Server: モデルを推論を行うための API として提供する OpenShift AI コンポーネントです。

NOTE: このアーキテクチャは、バックエンド部分と前後処理サービスを「マージ」することで簡素化できます。このワークショップでは、Pre-Post Processing サービスで実行されているコードが、前のセクションのノートブックで使用したコードと同じであることをご自身で確認できるように、2 つを分離しておきました。

== 5.2. アプリケーションをデプロイ

必要な YAML ファイルがすでに作成されているため、アプリケーションのデプロイは非常に簡単です。これらは、このワークショップで使用した Git プロジェクトに含まれています。これらは、**Jupyter 環境内の `deployment` フォルダー**で、または直接 https://github.com/rh-aiservices-bu/mad_m6_workshop/tree/main/deployment[ここ^] で見つけることができます。

もちろん、数分かけてフロントエンド、バックエンド、または前後処理サービスのコードを確認することもできます。

Pre-Post Processing Service サービスとアプリケーションをデプロイするには、次の手順を実行します。

* https://console-openshift-console.%SUBDOMAIN%/k8s/cluster/projects/%USERID%-data-science-project[OpenShift Console^] から

* これまで OpenShift クラスターにログインしたことがない場合は、次の認証情報を使用します。 OpenShift はすでに https://access.redhat.com/products/red-hat-single-sign-on/[Red Hat Single Sign On^] と統合されています。

image::sso_login.png[openshift_login]

*  資格情報を使用してログインします。

** Username: `%USERID%`
** Password: `{openshift-password}`

* プロジェクト **%USERID%-data-science-project** で、右上の「＋」記号の「YAML のインポート」ボタンを選択します。

image::import_yaml.png[]

- ファイル `pre_post_processor_deployment.yaml` の内容をウィンドウ内にコピー/ペーストします。指示に従ってモデルに `coolstore` という名前を付けていれば、準備完了です。そうでない場合は、35 行目の値を設定した名前に変更します。次に `作成` を選択します。

image::create_inference_service.png[]

- ファイル `intelligent_application_deployment.yaml` の内容をウィンドウ内にコピー/ペーストします。ここでは何も変更する必要はありません。 `作成` を選択します。

image::create_application_deployment.png[]

- 両方のデプロイメントが成功した場合は、 https://console-openshift-console.%SUBDOMAIN%/k8s/cluster/projects/%USERID%-data-science-project?view=graph[OpenShift Web console^] に戻ります。

image::deployment-complete.png[]

== 5.3. アプリケーションの使用

このアプリケーションは比較的簡単に使用できます。作成した `ia-frontend` の RouteのURL をクリックします。この URL は次のようになります: https://ia-frontend-%USERID%-data-science-project.%SUBDOMAIN%/[https://ia-frontend-%USERID%-data-science-project.%SUBDOMAIN%/ ^]

まずカメラの使用を許可する必要があります。次のインターフェイスが表示されます。

image::app_ui.png[]

以下が見えます。

- カメラの現在のビュー
- 写真を撮るボタン

image::take_picture_button.png[]

- 電話を使用している場合に前面カメラから背面カメラに切り替えるボタン

image::switch_camera_button.png[]

- **携帯電話** でアプリケーションをすばやく開くために使用できる QR コード (URL を入力するよりもはるかに簡単です!):

image::qr_code_example.png[]

写真を撮ると推論サービスに送信され、どのアイテムが検出されたか、利用可能なプロモーションがあるかどうかがわかります。

== 5.4. アプリケーションの微調整

このアプリケーションで変更できるパラメータは 2 つあります。

- `ia-frontend` デプロイメントでは、 `DISPLAY_BOX` 環境変数を `true` から `false` に変更できます。境界ボックスと推論スコアが非表示になるため、項目の上を *飛んでいる* クーポンだけが得られます。
- 前後処理に使用される `ia-inference` デプロイメントでは、 `COUPON_VALUE` 環境変数を変更できます。形式は、ボトル、帽子、シャツの 3 つのクラスのクーポンの値を含む単純な配列です。ご覧のとおり、これらの値はリアルタイムで調整でき、別の ML モデルに基づくこともできます。しかし、これは別のワークショップのテーマになります。




